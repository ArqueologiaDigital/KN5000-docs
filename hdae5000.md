---
layout: page
title: HDAE5000 Hard Disk Expansion
permalink: /hdae5000/
---

# HD-AE5000 Hard Disk Expansion

The HD-AE5000 is an optional hard disk expansion for the KN5000 that provides 1.08GB storage for music files. This page documents the reverse engineering of its firmware.

## Overview

| Property | Value |
|----------|-------|
| ROM File | `hd-ae5000_v2_06i.ic4` |
| ROM Size | 512KB |
| Base Address | 0x280000 |
| Firmware Version | 2.33J |
| Development Period | Juli-Oktober 1996 |
| Author | M. Kitajima |

The HDAE5000 firmware runs on the main CPU (TMP94C241F) when the expansion is present. It provides hard disk management, PC communication via parallel port, and file transfer capabilities.

## Hardware Interface

### PPI (8255) at 0x160000

The main CPU communicates with the HDAE5000 hardware via an Intel 8255 Programmable Peripheral Interface.

| Address | Port | Direction | Function |
|---------|------|-----------|----------|
| 0x160000 | Port A | Output | Data output |
| 0x160002 | Port B | Input | Status input |
| 0x160004 | Port C | Output | Control signals |
| 0x160006 | Control | Write | PPI configuration (0x82) |

**PPI Control Register Configuration (0x82):**
- Bit 7 = 1: Mode set active
- Port A: Mode 0, Output
- Port B: Mode 0, Input
- Port C: Output (both nibbles)

### Presence Detection

The HD-AE5000 presence is detected via PE port bit 0 (active low):

```asm
BIT 0, (PE)           ; Check PE port bit 0
JR NZ, skip_hdae      ; If set, HD-AE5000 NOT present
```

## ROM Entry Points

The HDAE5000 ROM has two primary entry points called by the main CPU firmware:

| Address | Function | Target | Description |
|---------|----------|--------|-------------|
| 0x280008 | Boot Init | JP 0x28F576 | Called during system initialization |
| 0x280010 | Frame Handler | JP 0x28F662 | Called each frame for PPORT polling |

### Boot Initialization (0x28F576)

Called once during system startup if HDAE5000 is detected. The initialization sequence:

1. **Store workspace pointer** - Saves main CPU workspace address at `0x23A1A2`
2. **Initialize code section** - Calls setup routines in code section 1 (0x280020)
3. **Copy data to DRAM** - Copies 76,800 bytes to work areas:
   - Area 1: `0x1A0000` (38,400 bytes)
   - Area 2: `0x1A9600` (38,400 bytes)
4. **Register handlers** - Registers callback handlers with main CPU's subsystem
5. **Check HD presence** - Calls routine at `0x2971A3` to detect hard disk
6. **Initialize HD** - If HD present, performs full initialization with parameters
7. **Register frame handler** - Sets up periodic update callback at `0x2803C2`

#### Key RAM Variables

| Address | Name | Purpose |
|---------|------|---------|
| 0x22A000 | HDAE5000_WORK_BUFFER | Work buffer (0xF52A bytes, cleared at init) |
| 0x23A19E | HDAE5000_WORKSPACE_PTR2 | Secondary workspace pointer |
| 0x23A1A2 | HDAE5000_WORKSPACE_PTR | Pointer to main workspace structure |
| 0x23952A | HDAE5000_DATA_COPY_DEST | Data copy destination |
| 0x230EC2 | HDAE5000_WORK_TEMP | Temporary work variable |
| 0x230EC4 | HDAE5000_STATE_VAR | State variable |
| 0x230EC6 | HDAE5000_CALC_RESULT | Calculation result storage |
| 0x230ECC | HDAE5000_HANDLER_1 | Registered handler function 1 |
| 0x230ED0 | HDAE5000_PREV_STATE | Previous state value |
| 0x230ED2 | HDAE5000_HANDLER_2 | Registered handler function 2 |
| 0x230ED6 | HDAE5000_HANDLER_3 | Registered handler function 3 |
| 0x230EDA | HDAE5000_INIT_FLAG | Initialization result (0=no HD, non-zero=HD present) |

### Frame Handler (0x28F662)

Called repeatedly during normal operation to:
- Poll for PC parallel port commands
- Process PPORT protocol state machine
- Handle file transfers and HD operations

## PPORT Command Protocol

The PPORT (PC Parallel Port) protocol enables communication with the HD-TechManager5000 Windows software. Commands are sent from the PC to the KN5000 via the parallel port.

### Command List

| Code | Command | Description |
|------|---------|-------------|
| 01 | Send Infos About HD | Report hard disk information to PC |
| 02 | Exit PPORT | Terminate parallel port session |
| 03 | Read FSB from HD | Read File System Block from hard disk |
| 04 | Sending FSB to PC | Transfer FSB data to PC |
| 05 | Rcv FSB from PC | Receive FSB data from PC |
| 06 | Writing FSB to HD | Write FSB to hard disk |
| 07 | Load HD to Memory | Load file from HD into KN5000 memory |
| 08 | Send data to PC | Generic data transfer to PC |
| 09 | Sending files to PC | File transfer to PC |
| 10 | Rcv data from PC | Receive data from PC |
| 11 | Save memory to HD | Save KN5000 memory to hard disk |
| 16 | Delete files | Delete files from hard disk |
| 17 | Formating HD | Format the hard disk |
| 18 | Switch HD-motor off | Power down HD motor (spin down) |
| 20 | Send XapFile flash | Transfer XAP file (flash data) |

### FSB (File System Block)

The FSB appears to be the filesystem metadata structure used by the HDAE5000. Operations 03-06 handle reading and writing this structure between the HD, KN5000 memory, and the PC.

## Windows DLL Callbacks

The HD-TechManager5000 Windows software uses DLL callbacks for UI interaction. These callback names were found in the firmware strings:

### Color and Display Callbacks
- `LyricBackColorCheck` - Background color validation for lyrics
- `LyricForeColorCheck` - Foreground color validation for lyrics
- `LyricJumpEditCheck` - Lyrics jump/edit mode validation

### Timer and Switch Callbacks
- `ErrMsgTimerCatch` - Error message display timer
- `FlsOverWrSwCatch` - Flash overwrite switch handler
- `AttenHDFormatSwCatch` - Attention HD format switch handler

### File Operation Callbacks
- `FlsOverWrSwCatch` - Overwrite switch
- `FlsDel1SwCatch`, `FlsDel2SwCatch` - Delete switches
- `FlsFileLoadSwCatch` - File load switch
- `FlsNamingCheck`, `FlsNamingCheck2` - File naming validation

### Hard Disk Operation Callbacks
- `AttenCpToMarkSwCatch` - Copy to mark attention
- `AttenCpToHDSwCatch` - Copy to HD attention
- `AttenHDFormatSwCatch` - HD format attention
- `AttenDelFileSwCatch` - Delete file attention
- `AttenDelDirSwCatch` - Delete directory attention

### Performance/Composition Callbacks
- `SeparateBassPartCheck` - Separate bass part mode
- `SeparateDrumPartCheck` - Separate drum part mode
- `SeparateOutputModeCheck` - Separate output mode
- `JumpAfterLoadModeEditCheck` - Jump after load option
- `LoadByNumberModeEditCheck` - Load by number option
- `QuickLoadModeEditCheck` - Quick load mode option
- `WriteConfirmEditCheck` - Write confirmation option
- `WriteProtectEditCheck` - Write protection option

### File Type Bit Callbacks (LBN prefix)
- `LBNMdBitCheck` - Melody files
- `LBNRcmBitCheck` - Rhythm Composer Memory
- `LBNMspBitCheck` - Music Style Programmer
- `LBNTmBitCheck` - Technical MIDI
- `LBNCmpBitCheck` - Composer files
- `LBNSqtBitCheck` - Sequencer Track
- `LBNPmtBitCheck` - Performance Memory Track
- `LBNLswBitCheck` - (Unknown type)

### Delete Operation Callbacks
- `DelTlxEditCheck` - Delete Technics Link files
- `DelMdEditCheck` - Delete Melody files
- `DelRcmEditCheck` - Delete RCM files
- `DelMspEditCheck` - Delete MSP files
- `DelTmEditCheck` - Delete TM files
- `DelCmpEditCheck` - Delete Composer files
- `DelSqtEditCheck` - Delete Sequencer files
- `DelPmtEditCheck` - Delete PMT files
- `DelLswEditCheck` - Delete LSW files
- `DelOptNameCheck`, `DelOptSwEventCatch` - Delete options

## File Types

The HDAE5000 handles various KN5000 file types, identified by suffix codes:

| Suffix | Full Name | Description |
|--------|-----------|-------------|
| Md | Melody | MIDI melody files |
| Rcm | Rhythm Composer Memory | Custom rhythm patterns |
| Msp | Music Style Programmer | Custom style programs |
| Tm | Technical MIDI | Technical MIDI data |
| Cmp | Composer | Composer sequences |
| Sqt | Sequencer Track | Sequencer track data |
| Pmt | Performance Memory Track | Performance memories |
| Lsw | (Unknown) | Possibly "Live Sound Workshop" |
| Tlx | Technics Link | Exchange files with other Technics products |

## UI Pages

| Page Name | Purpose |
|-----------|---------|
| PC_DATA_LINK_PAGE | PC data link interface |
| HDD_UTIL_PAGE | HDD utility operations |

## Firmware Versions

Multiple firmware versions exist for the HDAE5000:

| Version | Release Date | Notes |
|---------|--------------|-------|
| v1.10i | 1998-07-06 | Initial release |
| v1.15i | 1998-10-13 | Bug fixes |
| v2.0i | 1999-01-15 | Added lyrics display feature |
| v2.06i | Unknown | Analyzed version (2.33J internal) |

All versions are archived at [archive.org](https://archive.org/details/technics-kn5000-system-update-disks).

## Hardware Features

Based on marketing documentation and firmware analysis:

- **Storage**: 2.5" Hard Disk Drive (1.08 GB capacity)
- **Flash-ROM/SRAM**: Quick directory access cache
- **Parallel Port**: DB-25 connector for PC communication
- **Audio Outputs**: Channel separation options

### Limitations

Files cannot be played directly from the hard drive during performance. All file operations occur during breaks to protect the drive mechanism. This is a design decision to prevent disk wear during live performance.

## Update File Format

HDAE5000 firmware updates use file type ID 6:

```
Header: "Technics KN5000 HD-AEPRG DATA FILE    " (38 bytes)
Target: 0x280000 (512KB)
```

The update is loaded via the standard KN5000 firmware update mechanism when the appropriate disk is inserted.

## Embedded Images

Four 8-bit indexed color images were extracted from the HDAE5000 ROM. These images are displayed on the KN5000's LCD during HD-AE5000 operations.

### Palette Discovery

Disassembly analysis of the boot initialization code at `0x28f585` revealed the palette setup:
- **Main images** (Logo, Hands, FilePanel): Use palette at ROM offset `0x65dce` (CPU address `0x2E5DCE`)
- **Icon**: Uses Windows halftone-style palette at ROM offset `0x6158e`

The palette is loaded via a loop at `0x28f8e0` that iterates through all 256 entries, writing each RGB component (shifted right by 4 bits) to the VGA DAC registers at `0x3C8`/`0x3C9`.

### Image Locations

| Image | ROM Offset | CPU Address | Size | Description |
|-------|------------|-------------|------|-------------|
| [HDAE5000_Logo]({{ site.baseurl }}/image-gallery/#hd-ae5000-product-logo) | 0x2898e | 0x2A898E | 76,800 bytes | Product logo with hard disk graphic |
| [HDAE5000_Hands]({{ site.baseurl }}/image-gallery/#hands-operating-hd-ae5000) | 0x3b98e | 0x2BB98E | 76,800 bytes | Promotional image showing hands operating unit |
| [HDAE5000_FilePanel]({{ site.baseurl }}/image-gallery/#file-selection-panel) | 0x4e98e | 0x2CE98E | 76,800 bytes | File selection UI with texture buttons |
| [HDAE5000_Icon]({{ site.baseurl }}/image-gallery/#hard-disk-icon) | 0x6198e | 0x2E198E | 784 bytes | Hard disk with magnetic head icon |

Total embedded image data: ~231KB (images) + 2KB (palettes).

See the [Image Gallery]({{ site.baseurl }}/image-gallery/#hdae5000-hard-disk-expansion-rom-images) for the full images.

## ROM Layout

The 512KB ROM is organized into several sections:

| File Offset | Address | Size | Description |
|-------------|---------|------|-------------|
| 0x00000-0x0001F | 0x280000 | 32B | Header with "XAPR4" magic and entry vectors |
| 0x00020-0x003C1 | 0x280020 | 930B | Code section 1A - handler registration |
| 0x003C2-0x0F542 | 0x2803C2 | 61,825B | Code section 1B - Register_Frame and utilities |
| 0x0F543-0x0F56F | 0x28F543 | 45B | Alloc_Memory - display parameter lookup (DISASSEMBLED) |
| 0x0F570-0x0F575 | 0x28F570 | 6B | Get_Init_Flag - return HD presence flag (DISASSEMBLED) |
| 0x0F576-0x0F661 | 0x28F576 | 236B | Boot initialization routine |
| 0x0F662-0x0F784 | 0x28F662 | 291B | Frame handler main loop |
| 0x0F785-0x0F7DC | 0x28F785 | 88B | Clear_Work_Buffer - clear 0xF52A bytes, copy init data (LABEL) |
| 0x0F7DD-0x0F7ED | 0x28F7DD | 17B | Delay_Loop - decrement XWA until zero (LABEL) |
| 0x0F7EE-0x0F812 | 0x28F7EE | 37B | VGA_Port_Write - write to 0x170000+port (LABEL) |
| 0x0F813-0x0F8DF | 0x28F813 | 205B | Palette_Setup - set one VGA palette entry (LABEL EXPOSED) |
| 0x0F8E0-0x0F90A | 0x28F8E0 | 43B | Load_Palette (256 VGA entries) (DISASSEMBLED) |
| 0x0F90B-0x153E1 | 0x28F90B | 23,255B | Finalize_Init and remaining 2A code |
| 0x153E2-0x15411 | 0x2953E2 | 48B | PPORT command jump table (12 entries) |
| 0x15412-0x15641 | 0x295412 | 560B | PPORT menu strings |
| 0x15642-0x171A2 | 0x295642 | 7,009B | Code section 2B1 - PPORT handlers |
| 0x171A3-0x1AE9E | 0x2971A3 | 15,612B | Check_HD_Present and HD routines |
| 0x1AE9F-0x6FFFF | 0x29AE9F | 414,049B | MemCopy and remaining code/data |
| 0x70000-0x7FFFF | 0x2F0000 | 65,536B | Padding zeros |

## PPORT Command Handler Jump Table

Located at `0x2953E2`, this table contains 12 four-byte pointers to command handler routines:

| Index | Address | Handler | Description |
|-------|---------|---------|-------------|
| 0 | 0x2958D6 | Cmd01_SendInfo | Send HD info to PC |
| 1 | 0x295914 | Cmd02_Exit | Exit PPORT mode |
| 2 | 0x2959F6 | Cmd03_ReadFSB | Read FSB from HD |
| 3 | 0x295D3C | Cmd04_SendFSB | Send FSB to PC |
| 4 | 0x29605A | Cmd05_RcvFSB | Receive FSB from PC |
| 5 | 0x296294 | Cmd06_WriteFSB | Write FSB to HD |
| 6 | 0x29632A | Cmd07_LoadHD | Load HD to Memory |
| 7 | 0x29633C | Cmd08_SendData | Send data to PC |
| 8 | 0x2964A6 | Cmd09_SendFiles | Send files to PC |
| 9 | 0x296588 | Cmd10_RcvData | Receive data from PC |
| 10 | 0x29659A | Cmd11_SaveMem | Save memory to HD |
| 11 | 0x296680 | Cmd12_Nothing | (reserved) |

## Key Routine Addresses

### Code Section 1 (0x280020-0x28F575)

| Address | Name | Description |
|---------|------|-------------|
| 0x280020 | HDAE5000_Code_Section_1 | Handler registration entry |
| 0x28030E | HDAE5000_Alloc_Check | Memory allocation parameter check |
| 0x2803C2 | HDAE5000_Register_Frame | Register frame handler callback |
| 0x28F543 | HDAE5000_Alloc_Memory | Display parameter lookup (returns palette ptr, width, height) |
| 0x28F570 | HDAE5000_Get_Init_Flag | Return HD presence flag from 0x230EDA |

### Code Section 2 (0x28F662-0x2FFFFF)

| Address | Name | Description |
|---------|------|-------------|
| 0x28F662 | HDAE5000_Frame_Handler | Main frame handler entry point |
| 0x28F781 | HDAE5000_Frame_Handler_Exit | Exit to PPORT handler (JP 0x29501C) |
| 0x28F785 | HDAE5000_Clear_Work_Buffer | Clear 0xF52A bytes at 0x22A000, copy 0xC82 bytes from ROM |
| 0x28F7DD | HDAE5000_Delay_Loop | Nested delay loop - decrements XWA until zero |
| 0x28F7EE | HDAE5000_VGA_Port_Write | Write byte C to VGA port WA (mapped at 0x170000+port) |
| 0x28F813 | HDAE5000_Palette_Setup | Set one VGA palette entry (index in A, RGB in XBC) |
| 0x28F8E0 | HDAE5000_Load_Palette | Load all 256 palette entries from ROM data |
| 0x28F90B | HDAE5000_Finalize_Init | Just returns (stub) |
| 0x28F90C | HDAE5000_Display_Init | Display/callback initialization |
| 0x28B3B3 | HDAE5000_Check_Status | Status check routine |
| 0x28AC68 | HDAE5000_UI_Update | UI update routine |
| 0x29501C | HDAE5000_PPORT_Handler | PPORT state machine entry |
| 0x2950F8 | HDAE5000_Display_String | Display string routine (heavily used) |
| 0x2952D6 | HDAE5000_PPORT_Menu | PPORT menu handler |
| 0x2971A3 | HDAE5000_Check_HD_Present | Hard disk presence detection |
| 0x2999B0 | HDAE5000_Version_Info | Version string block |
| 0x29AE9F | HDAE5000_MemCopy | Memory copy utility |
| 0x29B72D | HDAE5000_Multiply | 32-bit multiply routine |
| 0x2F94B2 | HDAE5000_Init_Data | Data copied to 0x23952A (0xC82 bytes) |

### Frame Handler Flow

The frame handler at `0x28F662` performs these steps:
1. Check workspace pointer at `0x23A19E` (skip if -1)
2. Read handler states from `0x230ED2`, `0x230ED6`
3. Calculate display offset, store at `0x230EC6`
4. Call registered callbacks via workspace function pointers
5. Check handler 1 status bit 2 at `0x230ECC`
6. If status changed, call status routines at `0x28B3B3`
7. Exit via JP to PPORT handler at `0x29501C`

### Display Parameter Lookup (Alloc_Memory)

The `HDAE5000_Alloc_Memory` routine at `0x28F543` returns display-related parameters based on a request code in XBC:

| Request Code | Return Value | Description |
|--------------|--------------|-------------|
| 0x01E000A1 | 0x2E61CE | ROM address of palette data |
| 0x01E000A2 | 0x140 (320) | Display width in pixels |
| 0x01E000A3 | 0xF0 (240) | Display height in pixels |

The 320×240 resolution matches the KN5000's LCD display specifications.

### VGA Palette Setup

The HDAE5000 uses memory-mapped VGA DAC registers for palette control. VGA I/O ports are mapped to CPU address `0x170000 + port_number`:

| VGA Port | CPU Address | Function |
|----------|-------------|----------|
| 0x3C8 | 0x1703C8 | Palette index register (write) |
| 0x3C9 | 0x1703C9 | Palette data (R, G, B sequentially) |

**Palette Loading Sequence:**
1. `HDAE5000_Load_Palette` at `0x28F8E0` loops through indices 255 to 0
2. For each index, calculates offset = index × 4 into palette data
3. Calls `HDAE5000_Palette_Setup` at `0x28F813` with index and RGBX pointer
4. `Palette_Setup` writes index to 0x3C8, then R/G/B values to 0x3C9
5. RGB values are right-shifted by 4 (VGA DAC uses 6-bit color channels)

### Version Info Block (0x2999B0)

Contains identification strings:
- "Technics Software section    M. Kitajima"
- Version "2.33J", also "2.21"
- "TECHNICS KN5000"

## Disassembly Status

| Component | Status | Notes |
|-----------|--------|-------|
| ROM rebuild | **100%** | Byte-matching rebuild achieved |
| Entry point vectors | **100%** | JP instructions at 0x280008, 0x280010 |
| Boot initialization | **Disassembled** | 236 bytes at 0x28F576, fully documented with labels |
| Alloc_Memory | **Disassembled** | 45 bytes - display parameter lookup routine |
| Get_Init_Flag | **Disassembled** | 6 bytes - HD presence flag getter |
| Load_Palette | **Disassembled** | 43 bytes - loads all 256 VGA palette entries |
| Palette_Setup | **Label exposed** | 205 bytes - sets individual palette entry |
| Code section 1 | **Labeled** | Split into 3 parts (Code_Section_1, Register_Frame, utils) |
| Clear_Work_Buffer | **Label exposed** | 88 bytes - clears work area, copies init data |
| Delay_Loop | **Label exposed** | 17 bytes - nested delay loop |
| VGA_Port_Write | **Label exposed** | 37 bytes - writes to memory-mapped VGA ports |
| Frame handler | **Labeled** | Split into 7 parts with utility routines |
| PPORT jump table | **Disassembled** | 12 labeled dd entries |
| PPORT strings | Binary | 560 bytes (21 menu strings) |
| Code section 2B | **Labeled** | Split into 3 parts (Handlers, Check_HD_Present, MemCopy) |
| Embedded images | **100%** | 4 images + 2 palettes extracted (~233KB) |
| Filesystem | Not started | FSB structure unknown |

**Labels exposed: 23** | **Bytes disassembled: 330** (Boot_Init 236 + Alloc_Memory 45 + Get_Init_Flag 6 + Load_Palette 43)

## Related Documentation

- [Memory Map]({{ site.baseurl }}/memory-map/) - Address space layout
- [Hardware Architecture]({{ site.baseurl }}/hardware-architecture/) - System overview
- [Reverse Engineering]({{ site.baseurl }}/reverse-engineering/) - PPI interface details
- [System Update Procedures]({{ site.baseurl }}/reverse-engineering/#system-update-procedures) - Update file formats

## External References

- [HDAE5000 Technical Info](https://www.keysoftservice.ch/hdae5000-e.htm) - Keysoftservice documentation
- [System Update Disks Archive](https://archive.org/details/technics-kn5000-system-update-disks) - All firmware versions
