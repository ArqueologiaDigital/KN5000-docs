---
layout: page
title: HDAE5000 Hard Disk Expansion
permalink: /hdae5000/
---

# HD-AE5000 Hard Disk Expansion

The HD-AE5000 is an optional hard disk expansion for the KN5000 that provides 1.08GB storage for music files. This page documents the reverse engineering of its firmware.

## Overview

| Property | Value |
|----------|-------|
| ROM File | `hd-ae5000_v2_06i.ic4` |
| ROM Size | 512KB |
| Base Address | 0x280000 |
| Firmware Version | 2.33J |
| Development Period | Juli-Oktober 1996 |
| Author | M. Kitajima |

The HDAE5000 firmware runs on the main CPU (TMP94C241F) when the expansion is present. It provides hard disk management, PC communication via parallel port, and file transfer capabilities.

## Hardware Interface

### PPI (8255) at 0x160000

The main CPU communicates with the HDAE5000 hardware via an Intel 8255 Programmable Peripheral Interface.

| Address | Port | Direction | Function |
|---------|------|-----------|----------|
| 0x160000 | Port A | Output | Data output |
| 0x160002 | Port B | Input | Status input |
| 0x160004 | Port C | Output | Control signals |
| 0x160006 | Control | Write | PPI configuration (0x82) |

**PPI Control Register Configuration (0x82):**
- Bit 7 = 1: Mode set active
- Port A: Mode 0, Output
- Port B: Mode 0, Input
- Port C: Output (both nibbles)

### Presence Detection

The HD-AE5000 presence is detected via PE port bit 0 (active low):

```asm
BIT 0, (PE)           ; Check PE port bit 0
JR NZ, skip_hdae      ; If set, HD-AE5000 NOT present
```

## ROM Entry Points

The HDAE5000 ROM has two primary entry points called by the main CPU firmware:

| Address | Function | Target | Description |
|---------|----------|--------|-------------|
| 0x280008 | Boot Init | JP 0x28F576 | Called during system initialization |
| 0x280010 | Frame Handler | JP 0x28F662 | Called each frame for PPORT polling |

### Boot Initialization (0x28F576)

Called once during system startup if HDAE5000 is detected. Initializes:
- PPI configuration
- HD controller state
- Internal data structures

### Frame Handler (0x28F662)

Called repeatedly during normal operation to:
- Poll for PC parallel port commands
- Process PPORT protocol state machine
- Handle file transfers and HD operations

## PPORT Command Protocol

The PPORT (PC Parallel Port) protocol enables communication with the HD-TechManager5000 Windows software. Commands are sent from the PC to the KN5000 via the parallel port.

### Command List

| Code | Command | Description |
|------|---------|-------------|
| 01 | Send Infos About HD | Report hard disk information to PC |
| 02 | Exit PPORT | Terminate parallel port session |
| 03 | Read FSB from HD | Read File System Block from hard disk |
| 04 | Sending FSB to PC | Transfer FSB data to PC |
| 05 | Rcv FSB from PC | Receive FSB data from PC |
| 06 | Writing FSB to HD | Write FSB to hard disk |
| 07 | Load HD to Memory | Load file from HD into KN5000 memory |
| 08 | Send data to PC | Generic data transfer to PC |
| 09 | Sending files to PC | File transfer to PC |
| 10 | Rcv data from PC | Receive data from PC |
| 11 | Save memory to HD | Save KN5000 memory to hard disk |
| 16 | Delete files | Delete files from hard disk |
| 17 | Formating HD | Format the hard disk |
| 18 | Switch HD-motor off | Power down HD motor (spin down) |
| 20 | Send XapFile flash | Transfer XAP file (flash data) |

### FSB (File System Block)

The FSB appears to be the filesystem metadata structure used by the HDAE5000. Operations 03-06 handle reading and writing this structure between the HD, KN5000 memory, and the PC.

## Windows DLL Callbacks

The HD-TechManager5000 Windows software uses DLL callbacks for UI interaction. These callback names were found in the firmware strings:

### Color and Display Callbacks
- `LyricBackColorCheck` - Background color validation for lyrics
- `LyricForeColorCheck` - Foreground color validation for lyrics
- `LyricJumpEditCheck` - Lyrics jump/edit mode validation

### Timer and Switch Callbacks
- `ErrMsgTimerCatch` - Error message display timer
- `FlsOverWrSwCatch` - Flash overwrite switch handler
- `AttenHDFormatSwCatch` - Attention HD format switch handler

### Other Callbacks
Additional callback functions handle various PC software features for file management, display updates, and error handling.

## Firmware Versions

Multiple firmware versions exist for the HDAE5000:

| Version | Release Date | Notes |
|---------|--------------|-------|
| v1.10i | 1998-07-06 | Initial release |
| v1.15i | 1998-10-13 | Bug fixes |
| v2.0i | 1999-01-15 | Added lyrics display feature |
| v2.06i | Unknown | Analyzed version (2.33J internal) |

All versions are archived at [archive.org](https://archive.org/details/technics-kn5000-system-update-disks).

## Hardware Features

Based on marketing documentation and firmware analysis:

- **Storage**: 2.5" Hard Disk Drive (1.08 GB capacity)
- **Flash-ROM/SRAM**: Quick directory access cache
- **Parallel Port**: DB-25 connector for PC communication
- **Audio Outputs**: Channel separation options

### Limitations

Files cannot be played directly from the hard drive during performance. All file operations occur during breaks to protect the drive mechanism. This is a design decision to prevent disk wear during live performance.

## Update File Format

HDAE5000 firmware updates use file type ID 6:

```
Header: "Technics KN5000 HD-AEPRG DATA FILE    " (38 bytes)
Target: 0x280000 (512KB)
```

The update is loaded via the standard KN5000 firmware update mechanism when the appropriate disk is inserted.

## Disassembly Status

| Component | Status | Notes |
|-----------|--------|-------|
| Entry point vectors | Documented | JP instructions at 0x280008, 0x280010 |
| Boot initialization | Partial | Main entry at 0x28F576 |
| Frame handler | Partial | Main entry at 0x28F662 |
| PPORT commands | Documented | 15 commands identified |
| HD routines | Not started | File operations |
| Filesystem | Not started | FSB structure unknown |

## Related Documentation

- [Memory Map]({{ site.baseurl }}/memory-map/) - Address space layout
- [Hardware Architecture]({{ site.baseurl }}/hardware-architecture/) - System overview
- [Reverse Engineering]({{ site.baseurl }}/reverse-engineering/) - PPI interface details
- [System Update Procedures]({{ site.baseurl }}/reverse-engineering/#system-update-procedures) - Update file formats

## External References

- [HDAE5000 Technical Info](https://www.keysoftservice.ch/hdae5000-e.htm) - Keysoftservice documentation
- [System Update Disks Archive](https://archive.org/details/technics-kn5000-system-update-disks) - All firmware versions
